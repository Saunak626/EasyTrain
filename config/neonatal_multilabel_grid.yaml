# 新生儿多标签行为识别网格搜索配置
# 基于UCF101视频配置，适配新生儿多标签数据

# 任务配置
task:
  tag: "video_classification"  # 使用视频分类任务类型
  description: "新生儿多标签行为识别网格搜索"

# 训练配置
training:
  exp_name: "neonatal_multilabel_exp"
  save_model: true
  model_save_path: "models/neonatal_multilabel_model.pth"

# SwanLab配置
swanlab:
  project_name: "EasyTrain-Neonatal-Multilabel"
  description: "新生儿多标签行为识别网格搜索实验"

# 数据配置
data:
  type: neonatal_multilabel  # 使用新的新生儿多标签数据集类型
  root: /home/swq/Code/Neonate-Feeding-Assessment/data/cpu_processed/frames_segments  # 数据集根目录
  num_workers: 12       # 减少工作进程数，避免CPU和内存过载
  params:
    clip_len: 16      # 每个视频片段的帧数
    top_n_classes: 7  # 只使用样本数量前7多的类别，减少稀有类别干扰
    stratified_split: true  # 启用分层抽样，确保训练测试集类别分布一致
    min_samples_per_class: 10  # 类别最小样本数阈值

# 模型配置（仅保留必要的基础参数）
model:
  params:
    num_classes: 7  # 使用筛选后的类别数量（与top_n_classes保持一致）

# 超参数配置（基础默认值，可被网格搜索和命令行覆盖）
hp:
  epochs: 20

# GPU配置
gpu:
  device_ids: "2,3"
  auto_select: true

# 多卡训练配置
multi_gpu:
  enabled: true
  strategy: "ddp"

# 模型选择配置
models_to_train:
  # 启用要训练的模型列表，注释掉不需要训练的模型
  - "r3d_18"
  - "mc3_18"
  # - "r2plus1d_18"
  - "mvit_v1_b"
  - "mvit_v2_s"
  # - "swin3d_b"
  # - "swin3d_s"
  # - "swin3d_t"

# 网格搜索设置
max_experiments: 50
continue_on_error: true
parallel_jobs: 1
save_results: true
# results_file: "neonatal_multilabel_grid_search_results.csv"  # 注释掉以使用时间戳文件名

# 网格搜索超参数 - 分组式配置
grid_search:
  # 分组式搜索：每组模型有自己的超参数搜索范围
  groups:
    # 轻量级3D CNN模型组 - 使用更大的batch_size
    # 调度器选项说明：
    # - "step": 固定间隔降低学习率，参数：step_size, gamma
    # - "cosine": 余弦退火，参数：eta_min_factor (最小学习率比例)
    # - "plateau": 基于验证损失自适应，参数：factor, patience, mode
    # - "warmup_cosine": Warmup+余弦退火，参数：warmup_epochs, warmup_start_factor, eta_min_factor
    # - "linear": 线性衰减，参数：start_factor, end_factor
    # - "multistep": 多阶段衰减，参数：milestones, gamma
    # - "exponential": 指数衰减，参数：gamma
    light_3d_cnn:
      model.type: ["r3d_18", "mc3_18", "r2plus1d_18"]
      hp.batch_size: [64]  # 使用更大的batch_size，128优先
      hp.learning_rate: [0.001]  # 提高学习率，加快收敛
      optimizer.name: ["adamw"]
      optimizer.params.weight_decay: [0.05]
      scheduler.name: ["warmup_cosine"]  # 使用更简单的调度器
      scheduler.params.warmup_epochs: [1]  # Warmup期长度：1-2个epoch
      scheduler.params.warmup_start_factor: [0.1]  # Warmup起始学习率比例
      scheduler.params.eta_min_factor: [0.01]  # 最小学习率为初始学习率的1%
      scheduler.params.step_size: [5]  # 每5个epoch降低学习率（原来2→5，减缓衰减）
      scheduler.params.gamma: [0.8]  # 学习率衰减因子（原来0.5→0.8，减小衰减幅度）
      loss.name: ["multilabel_bce"]  # 多标签二元交叉熵损失
      loss.params.pos_weight: [10.0]  # 正样本权重，处理类别不平衡
      
    # Transformer模型组 - 精确配对batch_size，使用Warmup + Cosine调度策略
    transformer_models:
      model.type: ["mvit_v1_b", "mvit_v2_s"]
      hp.batch_size: [36, 32]  # 按顺序配对：mvit_v1_b用36，mvit_v2_s用32
      hp.learning_rate: [0.001]  # 降低学习率，更稳定
      optimizer.name: ["adamw"]  # Transformer首选AdamW
      optimizer.params.weight_decay: [0.05]  # 适中的权重衰减
      scheduler.name: ["warmup_cosine"]  # 使用更简单的调度器
      scheduler.params.warmup_epochs: [1]  # Warmup期长度：1-2个epoch
      scheduler.params.warmup_start_factor: [0.1]  # Warmup起始学习率比例
      scheduler.params.eta_min_factor: [0.01]  # 最小学习率为初始学习率的1%
      scheduler.params.step_size: [5]  # 每5个epoch降低学习率（原来2→5，减缓衰减）
      scheduler.params.gamma: [0.8]  # 学习率衰减因子（原来0.5→0.8，减小衰减幅度）
      loss.name: ["multilabel_bce"]  # 多标签二元交叉熵损失
      loss.params.pos_weight: [10.0]  # 正样本权重，处理类别不平衡
    
    # Swin3D模型组 - 精确配对batch_size，使用Warmup + Cosine调度策略
    swin3d_models:
      model.type: ["swin3d_b", "swin3d_s", "swin3d_t"]
      hp.batch_size: [16, 16, 16]  # 按顺序配对：swin3d_b用4，swin3d_s用8，swin3d_t用16
      hp.learning_rate: [0.001]  # 保守的学习率
      optimizer.name: ["adamw"]  # Swin系列推荐AdamW
      optimizer.params.weight_decay: [0.05]  # Swin系列用更大的weight_decay
      scheduler.name: ["warmup_cosine"]  # 使用更简单的调度器
      scheduler.params.warmup_epochs: [1]  # Warmup期长度：1-2个epoch
      scheduler.params.warmup_start_factor: [0.1]  # Warmup起始学习率比例
      scheduler.params.eta_min_factor: [0.01]  # 最小学习率为初始学习率的1%
      scheduler.params.step_size: [5]  # 每5个epoch降低学习率（原来2→5，减缓衰减）
      scheduler.params.gamma: [0.8]  # 学习率衰减因子（原来0.5→0.8，减小衰减幅度）
      loss.name: ["multilabel_bce"]  # 多标签二元交叉熵损失
      loss.params.pos_weight: [10.0]  # 正样本权重，处理类别不平衡

# 评估指标配置（暂时注释掉，使用默认指标）
# metrics:
#   - name: multilabel_accuracy
#   - name: multilabel_f1
#   - name: multilabel_precision
#   - name: multilabel_recall

# 日志和保存配置
# logging:
#   log_level: INFO
#   save_model: true
#   save_best_only: true
#   monitor_metric: "val_accuracy"  # 使用默认的准确率指标
#   monitor_mode: "max"

# # 数据采样配置（用于快速测试）
# sampling:
#   train_percentage: 1.0    # 训练数据使用比例
#   val_percentage: 1.0      # 验证数据使用比例

# # 环境配置
# environment:
#   cuda_visible_devices: "2,3"  # 指定使用的GPU
#   mixed_precision: false       # 是否使用混合精度训练
#   deterministic: true          # 确定性训练
#   seed: 42                     # 随机种子

# 输出配置
output:
  results_dir: "runs"
  experiment_name: "neonatal_multilabel_behavior"
  save_predictions: true
  save_confusion_matrix: true
